<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport"
    content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <title>전기차 충전소 지도</title>
  <script type="text/javascript" src="https://oapi.map.naver.com/openapi/v3/maps.js?ncpKeyId=x84uw6z21k"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <style>
    html,
    body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    #map {
      width: 100vw;
      height: 100vh;
      position: relative;
    }

    #progress {
      position: absolute;
      top: 20px;
      right: 24px;
      background: rgba(255, 255, 255, 0.87);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.12);
      padding: 10px 18px;
      border-radius: 15px;
      font-size: 16px;
      z-index: 20;
      pointer-events: none;
      min-width: 120px;
      text-align: center;
    }

    #legend {
      position: absolute;
      left: 18px;
      bottom: 18px;
      background: rgba(255, 255, 255, 0.95);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.10);
      padding: 7px 16px;
      border-radius: 12px;
      font-size: 16px;
      z-index: 21;
      display: flex;
      align-items: center;
      gap: 15px;
      pointer-events: none;
    }

    .legend-dot {
      display: inline-block;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      margin-right: 7px;
      border: 2px solid #1464ae;
      vertical-align: middle;
    }

    .legend-here {
      background: #3498fd;
      border-color: #1464ae;
    }

    .legend-me {
      background: #20c933;
      border-color: #04a824;
    }

    .legend-kakao {
      background: #ff0000;
      border-color: #cc0000;
    }

    #search-btn {
      position: absolute;
      top: 20px;
      left: 20px;
      z-index: 30;
      background: #3498fd;
      color: #fff;
      font-size: 18px;
      padding: 12px 24px;
      border-radius: 24px;
      border: none;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.11);
      cursor: pointer;
    }
  </style>
</head>

<body>
  <div id="map">
    <button id="search-btn">카카오 전기차충전소 검색(현재 지도 중심 기준)</button>

    <div id="progress">진행상황</div>
    <div id="legend">
      <span>
        <span class="legend-dot legend-here"></span> HERE
      </span>
      <span>
        <span class="legend-dot legend-me"></span> 환경부
      </span>
      <span>
        <span class="legend-dot legend-kakao"></span> 카카오
      </span>
    </div>
  </div>

  <script>
    var map = new naver.maps.Map('map', {
      gl: true,
      center: new naver.maps.LatLng(37.487573, 126.724144),
      zoom: 14
    });

    const greenIcon = {
      url: 'data:image/svg+xml;base64,' +
        btoa('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="#20c933" stroke="#04a824" stroke-width="2"/></svg>'),
      size: new naver.maps.Size(20, 20),
      scaledSize: new naver.maps.Size(20, 20),
      origin: new naver.maps.Point(0, 0),
      anchor: new naver.maps.Point(10, 10)
    };

    // 파란색 원 SVG Base64 (HERE)
    const blueIcon = {
      url: 'data:image/svg+xml;base64,' +
        btoa('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="#3498fd" stroke="#1464ae" stroke-width="2"/></svg>'),
      size: new naver.maps.Size(20, 20),
      scaledSize: new naver.maps.Size(20, 20),
      origin: new naver.maps.Point(0, 0),
      anchor: new naver.maps.Point(10, 10)
    };

    // 모든 마커 데이터 저장
    let allMarkersData = []; // {lat, lng, title, type}
    let markerObjs = [];     // 실제 지도 마커 객체 리스트

    // 마커 화면에 표시
    function updateMarkers() {
      // 현재 줌레벨과 bounds 얻기
      const curZoom = map.getZoom();
      const bounds = map.getBounds();

      // 기존 마커 모두 지도에서 제거
      markerObjs.forEach(mk => mk.setMap(null));
      markerObjs = [];

      if (curZoom < 15) {
        document.getElementById("progress").textContent = "줌레벨이 낮아서 마커를 표시하지 않습니다.";
        return;
      }

      let visibleCnt = 0;
      let visibleHereCount = 0;
      let visibleEnvCount = 0;
      // 현재 bounds 안에 있는 마커만 표시

      allMarkersData.forEach(info => {
        const latlng = new naver.maps.LatLng(info.lat, info.lng);
        if (bounds.hasLatLng(latlng)) {
          const icon = info.type === '환경부' ? greenIcon : blueIcon;
          const marker = new naver.maps.Marker({
            position: latlng,
            map: map,
            title: info.title,
            icon: icon
          });

          // 마커 클릭 시 정보창 표시
          const infowindow = new naver.maps.InfoWindow({
            content: `<div style="padding:5px;font-size:14px;">${info.title}</div>`
          });
          naver.maps.Event.addListener(marker, 'click', function () {
            infowindow.open(map, marker);
          });
          markerObjs.push(marker);
          if (info.type === "HERE") {
            visibleHereCount++;
          } else {
            visibleEnvCount++;
          }
          visibleCnt++;
        }
      });


      document.getElementById("progress").textContent = `현재 지도 내 충전소: ${visibleCnt}개(환경부: ${visibleEnvCount}, HERE: ${visibleHereCount})`;
    }

    // 지도 상태가 바뀔 때마다 마커 재구성
    map.addListener('zoom_changed', updateMarkers);
    map.addListener('dragend', updateMarkers);

    // CSV 파싱 및 좌표 데이터 저장
    Papa.parse('https://black924.github.io/siglo/ev/assets/25q4_ev.csv', {
      download: true,
      header: false,
      worker: false,
      chunk: function (results, parser) {
        // 결과 chunk.data : 각 청크의 행들(기본 10,000행)
        results.data.forEach(cells => {
          if (!cells || cells.length < 8) return;
          let type = (cells[0] || '').trim();
          let lat, lng, title;
          if (type === '환경부') {
            lng = parseFloat(cells[2]);
            lat = parseFloat(cells[3]);
            title = cells[1]
          } else if (type === 'HERE') {
            lat = parseFloat(cells[5]);
            lng = parseFloat(cells[6]);
            title = cells[4]
          } else {
            return;
          }

          allMarkersData.push({ lat, lng, title, type });
        });
        document.getElementById("progress").textContent =
          `CSV 일부 읽음: 현재까지 ${allMarkersData.length}개 누적`;
      },
      complete: function () {
        updateMarkers(); // 데이터 로딩되면 최초 마커 세팅
      }
    });

    let chargingMarkers = [];

    function clearChargingMarkers() {
      chargingMarkers.forEach(m => m.setMap(null));
      chargingMarkers = [];
    }

    // [카카오 45개 페이지 처리] ------------------------
    async function fetchKakaoAllPages(center) {
      const keyword = "전기차충전소";
      const y = center.y; // 위도
      const x = center.x; // 경도
      const radius = 1000;
      const baseUrl = "https://dapi.kakao.com/v2/local/search/keyword.json";
      const apiKey = "9bdb5de4f74cce81eb417e80907e2b8c";
      let allResults = [];

      for (let page = 1; page <= 3; page++) {
        const response = await fetch(
          `${baseUrl}?query=${encodeURIComponent(keyword)}&y=${y}&x=${x}&radius=${radius}&size=15&page=${page}`,
          {
            headers: {
              "Authorization": "KakaoAK " + apiKey
            }
          }
        );
        const data = await response.json();
        if (!data.documents || data.documents.length === 0) break;
        allResults = allResults.concat(data.documents);
        if (data.documents.length < 15) break;
      }
      return allResults;
    }
    // --------------------------------------------------

    document.getElementById('search-btn').onclick = async function () {
      clearChargingMarkers();
      const center = map.getCenter();

      // [카카오 45개 페이지 처리] 아래 한 줄만 주석 처리하고, 실제 45개 fetch로 교체
      // fetch(`https://dapi.kakao.com/v2/local/search/keyword.json?query=전기차충전소&y=${y}&x=${x}&radius=3000`, { ... })
      //   .then(response => response.json())
      //   .then(data => { ... })

      // [카카오 45개 페이지 처리] ---------
      const results = await fetchKakaoAllPages(center);

      const icon = {
        url: 'data:image/svg+xml;base64,' +
          btoa('<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20"><circle cx="10" cy="10" r="8" fill="#ff0000" stroke="#cc0000" stroke-width="2"/></svg>'),
        size: new naver.maps.Size(20, 20),
        scaledSize: new naver.maps.Size(20, 20),
        origin: new naver.maps.Point(0, 0),
        anchor: new naver.maps.Point(10, 10)
      };

      results.forEach(function (item) {
        const marker = new naver.maps.Marker({
          position: new naver.maps.LatLng(item.y, item.x),
          map: map,
          title: item.place_name,
          icon: icon
        });
        chargingMarkers.push(marker);

        const infowindow = new naver.maps.InfoWindow({
          content: `<div style="padding:5px;font-size:14px;">${item.place_name}</div>`
        });
        naver.maps.Event.addListener(marker, 'click', function () {
          infowindow.open(map, marker);
        });
      });
      // [카카오 45개 페이지 처리] ---------
    };


  </script>
</body>

</html>